name: VSCode - Documentation

on:
  push:
    branches: [main]
    paths:
      - 'packages/vscode/**'
      - '.github/workflows/vscode-documentation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/vscode/**'
      - '.github/workflows/vscode-documentation.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build React package (required for type dependencies)
        run: |
          echo "ðŸ“¦ Building React package for type dependencies..."
          npm run build
        working-directory: packages/react

      - name: Check TypeDoc documentation coverage
        run: |
          echo "ðŸ” Checking documentation coverage with TypeDoc..."
          npm run doc:coverage || true
        working-directory: packages/vscode
        continue-on-error: true

      - name: Generate TypeDoc HTML documentation
        run: |
          echo "ðŸ“š Generating TypeDoc HTML documentation with coverage..."
          npm run doc

          # Display coverage if available
          if [ -f "docs/coverage.json" ]; then
            echo "ðŸ“Š TypeDoc Coverage Report:"
            cat docs/coverage.json | python3 -m json.tool

            # Extract coverage percentage
            COVERAGE=$(cat docs/coverage.json | python3 -c "import json, sys; data = json.load(sys.stdin); print(data.get('percent', 0))")
            echo "Documentation Coverage: ${COVERAGE}%"
          fi
        working-directory: packages/vscode

      - name: Generate TypeDoc Markdown documentation
        run: |
          echo "ðŸ“ Generating TypeDoc Markdown documentation..."
          npm run doc:markdown
        working-directory: packages/vscode

      - name: Verify documentation output
        run: |
          echo "ðŸ” Verifying documentation was generated..."
          if [ -d "packages/vscode/docs" ]; then
            echo "âœ… HTML documentation generated successfully"
            echo "Files generated: $(find packages/vscode/docs -type f | wc -l)"
          else
            echo "âŒ HTML documentation generation failed"
            exit 1
          fi

          if [ -d "packages/vscode/docs-markdown" ]; then
            echo "âœ… Markdown documentation generated successfully"
            echo "Files generated: $(find packages/vscode/docs-markdown -type f | wc -l)"
          else
            echo "âŒ Markdown documentation generation failed"
            exit 1
          fi

      - name: Upload HTML documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-docs-html
          path: packages/vscode/docs/
          retention-days: 30
          if-no-files-found: error

      - name: Upload Markdown documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-docs-markdown
          path: packages/vscode/docs-markdown/
          retention-days: 30
          if-no-files-found: error

      - name: Generate documentation coverage report
        run: |
          echo "ðŸ“Š Analyzing documentation coverage..."

          # Get TypeDoc coverage data if available
          if [ -f "packages/vscode/docs/coverage.json" ]; then
            echo "Using TypeDoc coverage data..."
            COVERAGE=$(cat packages/vscode/docs/coverage.json | python3 -c "import json, sys; data = json.load(sys.stdin); print(int(data.get('percent', 0)))")
            EXPECTED=$(cat packages/vscode/docs/coverage.json | python3 -c "import json, sys; data = json.load(sys.stdin); print(data.get('expected', 0))")
            ACTUAL=$(cat packages/vscode/docs/coverage.json | python3 -c "import json, sys; data = json.load(sys.stdin); print(data.get('actual', 0))")
            NOT_DOCUMENTED=$(cat packages/vscode/docs/coverage.json | python3 -c "import json, sys; data = json.load(sys.stdin); print(len(data.get('notDocumented', [])))")
          else
            # Fallback to file counting
            TS_FILES=$(find packages/vscode/src -name "*.ts" -o -name "*.tsx" | wc -l)
            DOCUMENTED_FILES=$(grep -l "@module\|@description" --include="*.ts" --include="*.tsx" -r packages/vscode/src | wc -l || echo "0")

            if [ $TS_FILES -gt 0 ]; then
              COVERAGE=$((DOCUMENTED_FILES * 100 / TS_FILES))
            else
              COVERAGE=0
            fi
            EXPECTED=$TS_FILES
            ACTUAL=$DOCUMENTED_FILES
            NOT_DOCUMENTED=$((TS_FILES - DOCUMENTED_FILES))
          fi

          echo "Documentation coverage: ${COVERAGE}%"
          echo "Expected items: $EXPECTED"
          echo "Documented items: $ACTUAL"
          echo "Missing documentation: $NOT_DOCUMENTED"

          # Add to GitHub Step Summary
          echo "## ðŸ“š Documentation Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Statistics (TypeDoc)" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Documented Items**: $ACTUAL / $EXPECTED" >> $GITHUB_STEP_SUMMARY
          echo "- **Missing Documentation**: $NOT_DOCUMENTED items" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $COVERAGE -eq 100 ]; then
            echo "ðŸŽ‰ **Perfect**: 100% documentation coverage!" >> $GITHUB_STEP_SUMMARY
          elif [ $COVERAGE -ge 90 ]; then
            echo "âœ… **Excellent**: Documentation coverage is above 90%" >> $GITHUB_STEP_SUMMARY
          elif [ $COVERAGE -ge 80 ]; then
            echo "âœ… **Good**: Documentation coverage is above 80%" >> $GITHUB_STEP_SUMMARY
          elif [ $COVERAGE -ge 70 ]; then
            echo "ðŸ“ˆ **Fair**: Consider improving documentation coverage to reach 80%" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Warning**: Documentation coverage is below 70%" >> $GITHUB_STEP_SUMMARY
          fi

          # Add coverage badge info if available
          if [ -f "packages/vscode/docs/coverage.svg" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Coverage Badge" >> $GITHUB_STEP_SUMMARY
            echo "A coverage badge has been generated and is available in the artifacts." >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check for missing JSDoc comments
        run: |
          echo "ðŸ”Ž Checking for exported functions without JSDoc..."

          # Find exported functions without preceding JSDoc
          MISSING_DOCS=$(grep -B2 "^export.*function\|^export.*class\|^export.*interface" --include="*.ts" --include="*.tsx" -r packages/vscode/src | \
            grep -v "/\*\*" | \
            grep "export" | \
            head -10 || true)

          if [ -n "$MISSING_DOCS" ]; then
            echo "âš ï¸ Found exports potentially missing JSDoc comments:"
            echo "$MISSING_DOCS"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Exports Missing Documentation" >> $GITHUB_STEP_SUMMARY
            echo "Some exported items may be missing JSDoc comments. Run \`npm run doc\` locally to verify." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All exports appear to have documentation"
          fi
        continue-on-error: true

      - name: Generate documentation summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Documentation Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Documentation**: Available as \`vscode-docs-html\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "- **Markdown Documentation**: Available as \`vscode-docs-markdown\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the documentation artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the HTML docs by opening \`index.html\` in a browser" >> $GITHUB_STEP_SUMMARY
          echo "3. Use the Markdown docs for integration with other documentation systems" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Local Documentation" >> $GITHUB_STEP_SUMMARY
          echo "To generate documentation locally:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd packages/vscode" >> $GITHUB_STEP_SUMMARY
          echo "npm run doc          # HTML docs with coverage" >> $GITHUB_STEP_SUMMARY
          echo "npm run doc:markdown # Markdown docs" >> $GITHUB_STEP_SUMMARY
          echo "npm run doc:coverage # Check coverage only" >> $GITHUB_STEP_SUMMARY
          echo "npm run doc:watch    # Watch mode" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
