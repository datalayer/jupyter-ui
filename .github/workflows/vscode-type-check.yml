name: VSCode - Type Check

on:
  push:
    branches: [main]
    paths:
      - 'packages/vscode/**'
      - '.github/workflows/vscode-type-check.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/vscode/**'
      - '.github/workflows/vscode-type-check.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  type-check:
    name: TypeScript Type Checking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build React package (required for types)
        run: |
          echo "ðŸ“¦ Building React package for type dependencies..."
          npm run build
        working-directory: packages/react

      - name: Run TypeScript compiler check
        run: |
          echo "ðŸ” Running TypeScript type checking..."
          npx tsc --noEmit
        working-directory: packages/vscode

      - name: Check for strict mode compliance
        run: |
          echo "ðŸ”’ Verifying strict mode compliance..."
          npx tsc --noEmit --strict
        working-directory: packages/vscode
        continue-on-error: true

      - name: Check for unused exports
        run: |
          echo "ðŸ§¹ Checking for unused exports..."
          npx ts-prune --error || echo "::warning::Found unused exports. Consider removing them."
        working-directory: packages/vscode
        continue-on-error: true

      - name: Validate tsconfig.json
        run: |
          echo "âš™ï¸ Validating TypeScript configuration..."
          npx tsc --showConfig > /dev/null
          if [ $? -eq 0 ]; then
            echo "âœ… tsconfig.json is valid"
          else
            echo "âŒ tsconfig.json validation failed"
            exit 1
          fi
        working-directory: packages/vscode

      - name: Check declaration files generation
        run: |
          echo "ðŸ“ Testing declaration files generation..."
          npx tsc --declaration --emitDeclarationOnly --outDir temp-types
          if [ -d "temp-types" ]; then
            echo "âœ… Declaration files can be generated successfully"
            rm -rf temp-types
          else
            echo "âš ï¸ Failed to generate declaration files"
          fi
        working-directory: packages/vscode
        continue-on-error: true

      - name: Analyze type coverage
        run: |
          echo "ðŸ“Š Analyzing type coverage..."
          npx type-coverage --detail || echo "::notice::Type coverage analysis not available"
        working-directory: packages/vscode
        continue-on-error: true

      - name: Check for any type usage
        run: |
          echo "ðŸš« Checking for 'any' type usage..."
          if grep -r ": any" --include="*.ts" --include="*.tsx" \
             --exclude-dir="node_modules" --exclude-dir="dist" \
             --exclude-dir="out" \
             packages/vscode/src; then
            echo "::warning::Found explicit 'any' types. Consider using more specific types."
          else
            echo "âœ… No explicit 'any' types found"
          fi
        continue-on-error: true

      - name: Generate type check report
        if: always()
        run: |
          echo "## ðŸ“Š TypeScript Type Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Required Checks" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript compilation (no emit)" >> $GITHUB_STEP_SUMMARY
          echo "- tsconfig.json validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Optional Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Strict mode compliance" >> $GITHUB_STEP_SUMMARY
          echo "- Unused exports detection" >> $GITHUB_STEP_SUMMARY
          echo "- Declaration files generation" >> $GITHUB_STEP_SUMMARY
          echo "- Type coverage analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Explicit 'any' type usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`npx tsc --noEmit\` locally before committing" >> $GITHUB_STEP_SUMMARY
          echo "- Consider enabling strict mode for better type safety" >> $GITHUB_STEP_SUMMARY
          echo "- Replace 'any' types with specific types where possible" >> $GITHUB_STEP_SUMMARY
